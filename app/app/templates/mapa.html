{% extends "base.html" %}
{% load static %}
{% block title %}Mapa{% endblock %}
{% block metaExtra %}
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAgjikgvQhbMSDx-zIT62Uly1io0NLpJ_4"></script>
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
{% endblock %}

{% block cssExtra %}
      #map {
        height: 100vh;
        width: 100%;
      }
      .infowindow-content {
        /*min-width: 90vw;*/
        /*max-width: 300px;*/
      }
      .infowindow-img {
        width: 100%;
        height: auto;
        display: block;
      }
      @media (max-width: 600px) {
        .infowindow-content {
          min-width: 90vw;
        }
      }
{% endblock %}
{% block subtitulo %}Mapa{% endblock %}
{% block content %}

    <div class="flex items-center gap-4">
      Clique em <img src="{% static 'imagens/tela_cheia.png' %}"> para um uso mais simplificado do mapa.
    </div>
    
    <div id="map"></div>

    <div id="loader" style="
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
        background: rgba(255,255,255,0.8);
        padding: 5px 10px;
        border-radius: 5px;
        font-weight: bold;
    ">
        Carregando pontos...
    </div>
    <script>

      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 6,
          center: { lat: -13.349274, lng: -55.933231 },
          zoomControl: true,        // Ativa o controle de zoom (default true, mas vamos garantir)
          zoomControlOptions: {
            position: google.maps.ControlPosition.RIGHT_CENTER // Posição dos controles
          }
        });

        const infoWindow = new google.maps.InfoWindow();

        // Mostra loader
        document.getElementById("loader").style.display = "block";

        // Carrega pontos via AJAX
        fetch("{% url 'pontos_json' %}")
          .then(response => response.json())
          .then(data => {
            const markers = data.pontos.map(loc => {
              const marker = new google.maps.Marker({
                position: { lat: loc.lat, lng: loc.lng }
              });

              marker.addListener("click", () => {
                infoWindow.setContent(loc.info);
                infoWindow.open(map, marker);
                google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
                  document.getElementById(loc.imgId).src = loc.imgUrl;
                });
              });

              return marker;
            });

            new markerClusterer.MarkerClusterer({ map, markers });

            // Esconde loader
            document.getElementById("loader").style.display = "none";
          })
          .catch(err => {
            console.error("Erro ao carregar pontos:", err);
            document.getElementById("loader").innerText = "Erro ao carregar pontos";
          });

      }

      window.onload = initMap;
    </script>

{% endblock %}